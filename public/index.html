
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GoTravel 安装向导</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#111827">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:0; background:#f9fafb; color:#111827}
    .wrap{max-width:720px; margin:48px auto; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden}
    header{padding:24px 28px; background:#111827; color:#fff}
    main{padding:28px}
    h1{margin:0 0 8px}
    .step{display:none}
    .step.active{display:block}
    .row{display:flex; gap:12px; margin-top:16px}
    button{flex:0 0 auto; padding:12px 18px; border-radius:10px; border:0; background:#111827; color:#fff; cursor:pointer}
    button.secondary{background:#4b5563}
    button:disabled{opacity:.5; cursor:not-allowed}
    .msg{margin-top:16px; padding:12px 14px; border-radius:10px; background:#f3f4f6}
    .msg.error{background:#fee2e2; color:#991b1b}
    .msg.success{background:#dcfce7; color:#166534}
    code{background:#f3f4f6; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>GoTravel 安装向导</h1>
      <p>如果你遇到“解析失败，请重试”，请使用下面的“重新解析”按钮。</p>
    </header>
    <main>
      <section id="step1" class="step active">
        <h2>步骤 1：环境检查</h2>
        <p>点击“安装依赖”进行检查和安装。</p>
        <div class="row">
          <button id="btn-install">安装依赖</button>
          <button id="btn-next-1" class="secondary" disabled>下一步</button>
        </div>
        <div id="msg-1" class="msg">未开始</div>
      </section>

      <section id="step2" class="step">
        <h2>步骤 2：生成配置</h2>
        <p>点击“开始生成”触发后端 API（<code>/api/generate</code>）。</p>
        <div class="row">
          <button id="btn-generate">开始生成</button>
          <button id="btn-retry" class="secondary" style="display:none">重新解析</button>
          <button id="btn-next-2" class="secondary" disabled>下一步</button>
        </div>
        <div id="msg-2" class="msg">等待操作</div>
      </section>

      <section id="step3" class="step">
        <h2>步骤 3：完成</h2>
        <p class="msg success">✅ 已完成！可以部署到 Vercel 或本地静态服务器。</p>
      </section>
    </main>
  </div>

  <script>
    // PWA register
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    }

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const msg1 = document.getElementById('msg-1');
    const msg2 = document.getElementById('msg-2');

    document.getElementById('btn-install').addEventListener('click', async () => {
      const btn = event.target;
      btn.disabled = true;
      msg1.textContent = '正在检查依赖…';
      try {
        const res = await fetch('/api/health');
        if (!res.ok) throw new Error('后端不可用');
        const j = await res.json();
        msg1.textContent = '依赖正常：' + j.message;
        document.getElementById('btn-next-1').disabled = false;
      } catch (e) {
        msg1.classList.add('error');
        msg1.textContent = '安装/检查失败：' + e.message + '。请稍后再试。';
        btn.disabled = false;
      }
    });

    document.getElementById('btn-next-1').addEventListener('click', () => {
      step1.classList.remove('active');
      step2.classList.add('active');
    });

    async function callGenerate() {
      msg2.textContent = '正在解析与生成…';
      document.getElementById('btn-generate').disabled = true;
      try {
        const res = await fetch('/api/generate', { method: 'POST' });
        const j = await res.json();
        if (!res.ok || j.status !== 'ok') throw new Error(j.error || '解析失败');
        msg2.classList.remove('error');
        msg2.classList.add('success');
        msg2.textContent = '生成成功：' + j.detail;
        document.getElementById('btn-next-2').disabled = false;
        document.getElementById('btn-retry').style.display = 'none';
      } catch (e) {
        msg2.classList.add('error');
        msg2.textContent = '解析失败，请重试：' + e.message;
        document.getElementById('btn-retry').style.display = 'inline-block';
      } finally {
        document.getElementById('btn-generate').disabled = false;
      }
    }

    document.getElementById('btn-generate').addEventListener('click', callGenerate);
    document.getElementById('btn-retry').addEventListener('click', callGenerate);

    document.getElementById('btn-next-2').addEventListener('click', () => {
      step2.classList.remove('active');
      step3.classList.add('active');
    });
  </script>
</body>
</html>
